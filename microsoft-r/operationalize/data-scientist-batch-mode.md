---

# required metadata
title: "Batch Scoring & Deployment"
description: "mrsdeploy Functions"
keywords: "mrsdeploy package reference"
author: "j-martens"
manager: "jhubbard"
ms.date: "2/14/2017"
ms.topic: "reference"
ms.prod: "microsoft-r"
ms.service: ""
ms.assetid: ""

# optional metadata
ROBOTS: ""
audience: ""
ms.devlang: ""
ms.reviewer: ""
ms.suite: ""
ms.tgt_pltfrm: ""
ms.technology: "r-server"
ms.custom: ""

---

# Asynchronous service consumption via batch processing

**Applies to:  Microsoft R Server 9.1**

The typical approach to consuming web services, ["Request Response" consumption](data-scientist-manage-services.md#consume-service), involves a single API call to execute the code in that web service once. In this article, you'll learn how to perform "Asynchronous Batch" consumption. The Asynchronous Batch approach involves the execution of code without manual intervention using multiple asynchronous API calls on a specific web service sent as a single request to R Server. Then, R Server will immediately execute those operations once for every row of data provided. 



## Asynchronous batch workflow

Generally speaking, the process for asynchronous batch consumption of a web service involves the following:
1. Call the web service on which the batch execution should be run
1. Define the record data for the batch execution task
1. Start the task
1. Monitor and interact with the task and its results
1. Get the execution results and download any files produced


Use these following [public API functions](data-scientist-manage-services.md#api-client-batch)  to define, start, and interact with your batch executions.

![Batch execution](../media/o16n/data-scientist-batch.png) 

### End-to-end workflow example
For a quick review of the end-to-end workflow for asynchronous batch executions of web services, check out this example. Here we use the `mtService` web service that was published using the example in the [Get Started for Data Scientist](data-scientist-get-started.md) article. 

```R
##########################################################################
#            Perform Batch Consumption & Get Swagger in R                #
##########################################################################

# Use `remoteLogin` to authenticate with R Server using the local admin 
# account. Use session = false so no remote R session started
remoteLogin("http://localhost:12800", 
            username = “admin”, 
            password = “{{YOUR_PASSWORD}}”,
            session = FALSE)
   
# Get the service using `getService()` function from `mrsdeploy`
# Assign service to the variable `service4Batch`.
service4Batch <- getService("mtService", "v1.0.0")

# Define the record data for the batch execution task.  Record data comes 
# from a data.frame called mtcars. Note: mtcars is a data.frame of 
# 11 cols with names (mpg, cyl, ..., carb) and 32 rows of numerics. 
# Assign to the batch object called 'myBatch'.
record <- mtcars
myBatch <- service4Batch$batch(records) 

# Set thread count using parallelCount. Default is 10.
# myBatch <- service4Batch$batch(records, parallelCount = 5) 

# Start the batch task
myBatch$start()

# Get the task id to reference during or after its execution:
myBatch$id()

# If you need to cancel the batch execution, try this:
# myBatch$cancel()

# Monitor batch execution results with public function $results().
# Check results every 3 seconds until task finishes or fails. 
# Assign returned results to batch result object we called 'batchres'.
batchRes <- NULL
while(TRUE) {
   batchres <- batch$results()

   if (batchRes$status == myBatch$STATUS$failed) { stop("Batch execution failed") } 
   if (batchRes$status == myBatch$STATUS$complete) { break }
      
   Sys.sleep(3)
}
      
# Once the batch task is complete, get the execution records by index from 
# the batch results object, 'batchRes'. This object is the service output.
# totalItemCount = # of records in data.

# For every record, return these four results: 
for(i in seq(batchRes$totalItemCount)) {

   #1. List of every file that was generated by this execution index.
       files <- myBatch$listFiles(i)
    
   #2. Display the file contents of each file returned in the above list.
       for (fileName in files) {
          content <- myBatch$fileContent(i, fileName)
          if (is.null(content)) { stop("Unable to get file") }
       }
 
   #3. Download files from execution index to the current working directory  
       # unless a dest = "<path>" is specified.

       # Download of a single named file: 
       myBatch$download(i, myHistogramFile)

       # Download of all files:
       myBatch$download(i, dest = "~bgates/dev/null")
   
   #4. Get results for a given index row returned as an array 
       # assign it to the batch results object 
       exe <- batchRes$execution(i)
       singleRowDataFrame <- exc$outputParameters$output
}

# Print response output named `answer`
print(result$output("answer")) # 0.6418125  

# Since you're authenticated already, get `swagger.json` file now.
swagger <- service4Batch$swagger()
cat(swagger, file = "swagger.json", append = FALSE)
``` 




## Step 1: Get the web service from R Server

Once you have authenticated (see workflow example), you can retrieve the web service, assign it to a variable, and define the inputs to it as record data in a data frame (or CSV, TSV, ...). 

Batching begins by retrieving the web service containing the code you'll run against the inputs you define next. You can get a service using its name and version with the `getService()` function from `mrsdeploy`. 

**For example:**
```R   
service4Batch <- getService("mtService", "v1.0.0")
```

This function is covered in detail in [this article](data-scientist-manage-services.md). 

**Arguments**

- `name`: the name of the web service
- `version`: the version of the web service

**Return**

The result is a service object, which in our example is called `service4Batch`.

<a name="batch-function"></a>

## Step 2: Define the record data to be batched

Next, use the batch public api function `$batch` to define the input record data for the batch and set the number of concurrent threads for processing. 

**For example:**
```R
myBatch <- service4Batch$batch(inputs, parallelCount = 10)
```

**Arguments**

+ `inputs`: 
   + data.frame
     ```R
     #########################################################################
     #                  Define from a `data.frame`                           #
     #########################################################################
     # mtcars is a data.frame of 11 cols and 32 rows of numerics
     # Assign the data.frame to 'records' variable.
     # Use 'records' as input into batch execution.
     # Reduce thread count to 5.
     records <- mtcars
 
     myBatch <- myService$batch(records, parallelCount = 5)
     ```
  
   + flat list converted to a data.frame using the base R function, `read.csv`.
     ```R
     #########################################################################
     #              Define from a flat list via  `read.csv()`                #
     #########################################################################
     # mtcars is in a CSV file this time. 
     # Use read.csv function to read it in as a data.frame.
     # Assign that data.frame to 'records' variable.
     # Use 'records' as input into batch execution.
     records <- read.csv("mtcars.csv")
     myBatch  <- service$batch(records)

     # mtcars from a TSV file this time. 
     # Declare the separator.
     records <- read.csv("mtcars.tsv", sep = "\t")
     myBatch  <- service$batch(records)
     ``` 

- `parallelCount`: Number of concurrent threads that can be dedicated to processing records in the 
batch. Default value is 10. Take care not to set a number so high that it negatively impacts performance.

**Return**

The result is a batch object, which in our example is called `myBatch`.


<a name="start-function"></a>

## Step 3 & 4: Start, monitor, cancel the batch execution

Next, use the public api functions to start the asynchronous batch execution on the batch object, monitor the execution, or even cancel it.

### Start 
Start the batch task with the public function `start()`. R Server starts the batch execution and assigns an ID to the execution.

**For example:**
```R
myBatch$start()
```

### Get batch id
Get the task id to reference during or after its execution with the public function `id()`. R Server returns the ID for the named batch object.

**For example:**
```R
myBatch$id()
```

### Monitor results and status
You can monitor the batch execution results with the public function `results()` and the status of the batch execution using the public function `STATUS`.

**For example:**
```R
batchRes <- NULL
while(TRUE) {
   batchres <- batch$results()

   if (batchRes$status == myBatch$STATUS$failed) { stop("Batch execution failed") } 
   if (batchRes$status == myBatch$STATUS$complete) { break }
      
   Sys.sleep(3)
}
```

### Cancel execution
Cancel the batch execution of the named batch object using the public function `cancel()`.

**For example:**

```R
myBatch$cancel()
```






========================

Other assumptions/questions:

1. O16N now supports two new inputs: rdata.frame and csv so we can use arrays, or lists.  
   - Batch specific only?? Or accepted input to any web service produced by O16N via mrsdeploy or API?  Is that true? 
   - What about for realtime scoring?

1. There are several new public function. They are:


```R
# Register service to be batched
batch <- service$batch(inputs, parallelCount = 10)

# Find batch using its execution identifier
batch <- service$getBatch(id)

# Get the list of batch execution identifiers
ids <- service$getBatchExecutions()
```

**Batch functions performed on the service object**
Once you get the service object, you can use these public functions on that service.

| Function      | Description                                            |
| ------------- |--------------------------------------------------------|
| `batch` |Define the data records  to be batched and the concurrent thread count. [Learn more...](data-scientist-get-started#batch-function)|
| `getBatchExecutions` |Get the list of batch execution identifiers. |
| `getBatch` |Get batch object using its unique execution identifier |

**Batch functions performed on the batch object**
Once you have the batch object, you can use these public functions to interact with it.

| Function      | Description                                            |
| ------------- |--------------------------------------------------------|
| `start` |	Starts the execution of a batch scoring operation, such as `batch$start()` |
| `cancel` |	Cancel the current batch execution, such as `batch$cancel()`|
| `id` |	Get the execution identifier for the current batch process, such as `id <- batch$id()`         |
| `results` |	Download all files or just the helper function (default dest = getwd())  |
| `file` |	Get the results of the execution by filename  |
| `download` |	Download all files or just the helper function (default dest = getwd())  |

1. We’ll need an example users can actually try out of the box on their own. Nothing that relies on data files or models the users don't have access to or instructions on how to create. 

1. Call the service by name/version
1. Define the data records, as a data.frame or flat list, to be batched
1. Start the batch execution
1. Get the batch results and any associated files
1. When necessary, cancel the batch execution





 A Batch Execution Service (BES) is a service that handles high volume, asynchronous, scoring of a batch of data records. 




## `Batch` object

Batching is accessible from the service object. 
Functions on the batch object.

```R
# Get service to batch
service <- getService("mtcars")

# Register service to be batched
batch <- service$batch(records, parallelCount = 10)

# Start batch execution
batch$start()

# Get execution identifier for the started batch process
id <- batch$id()

# Cancel batch execution
batch$cancel()

# Poll for batch execution results
batchResult <- batch$results(partialResults = TRUE)

# Get file content by filename
content <- batch$fileContent(index, fileName)
   
# Download helper function (default dest = getwd())
batch$download(index, fileName, dest = "~admin/dev/null") 

# Download all files
batch$download(index)
```

### Start batch execution

```R
start()
```

**Return**

The `Batch` object

### Cancel batch execution

```R
cancel()
```
**Return**

The `Batch` object

### Get execution identifier

```R
id()
```

**Return**

The execution identifier

### Get batch execution results

```R
batch$results(partialResult = TRUE)
```

**Arguments**

- partialResults: Returns the already processed results of the batch execution even if it has not been fully completed.

**Return**

The `BatchResult` object

### Get file content by filename

```R
file(index, fileName)
```

**Arguments**

- index: Batch execution record index
- filename: Name of file artifact created during batch execution

**Return**

### Download helper function (default dest = getwd())

```R
download(index, fileName, dest = getwd())
```

**Arguments**

- index: Batch execution record index
- filename: Name of file artifact created during batch execution
- dest: The download desition. The default is working directory.

**Return**

Filepath to download location

### Download all files

```R
download(index)
```
**Arguments**

- index: Batch execution record index

**Return**

List of filepaths to download location

## `BatchResult` object

### Get batch execution results

```R
execution(index)
```

**Arguments**

- index: Batch execution record index

**Return**

List of lists of batch execution results



## See also

+ [mrsdeploy function overview](../mrsdeploy/mrsdeploy.md)
+ [Data scientist get started guide](data-scientist-get-started.md)
+ [Working with web services in R](../operationalize/data-scientist-manage-services.md)
+ [Execute on a remote Microsoft R Server](../operationalize/remote-execution.md)
+ [Application developer get started guide](../operationalize/app-developer-get-started.md)
