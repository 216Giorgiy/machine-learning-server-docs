---

# required metadata
title: "Batch Scoring & Deployment"
description: "mrsdeploy Functions"
keywords: "mrsdeploy package reference"
author: "j-martens"
manager: "jhubbard"
ms.date: "2/14/2017"
ms.topic: "reference"
ms.prod: "microsoft-r"
ms.service: ""
ms.assetid: ""

# optional metadata
ROBOTS: ""
audience: ""
ms.devlang: ""
ms.reviewer: ""
ms.suite: ""
ms.tgt_pltfrm: ""
ms.technology: "r-server"
ms.custom: ""

---

# Asynchronous service consumption via batch processing

**Applies to:  Microsoft R Server 9.1**

The typical approach to consuming web services, ["Request Response" consumption](data-scientist-manage-services.md#consume-service), involves a single API call to execute the code in that web service once. In this article, you'll learn how to perform "Asynchronous Batch" consumption. The Asynchronous Batch approach involves the execution of code without manual intervention using multiple asynchronous API calls on a specific web service sent as a single request to R Server. Then, R Server will immediately execute those operations once for every row of data provided. 



## Asynchronous batch workflow

Generally speaking, the process for asynchronous batch consumption of a web service involves the following:
1. Call the web service on which the batch execution should be run
1. Define the record data for the batch execution task
1. Start the task
1. Monitor and interact with the task and its results
1. Get the execution results and download any files produced

Use these following [public API functions](data-scientist-manage-services.md#api-client-batch)  to define, start, and interact with your batch executions.

![Batch execution](../media/o16n/data-scientist-batch.png) 

### End-to-end workflow example
For a quick review of the end-to-end workflow for asynchronous batch executions of web services, check out this example. Here we use the `mtService` web service that was published using the example in the [Get Started for Data Scientist](data-scientist-get-started.md) article. 

```R
##########################################################################
#            Perform Batch Consumption & Get Swagger in R                #
##########################################################################

# Use `remoteLogin` to authenticate with R Server using the local admin 
# account. Use session = false so no remote R session started
remoteLogin("http://localhost:12800", 
            username = “admin”, 
            password = “{{YOUR_PASSWORD}}”,
            session = FALSE)
   
# Get the service using `getService()` function from `mrsdeploy`
# Assign service to the variable `api`.
api <- getService("mtService", "v1.0.0")

# Define the record data for the batch execution task.  Record data comes 
# from a data.frame called mtcars. Note: mtcars is a data.frame of 
# 11 cols with names (mpg, cyl, ..., carb) and 32 rows of numerics. 
record <- mtcars
batch <- api$batch(records) 

# Set thread count using parallelCount. Default is 10.
# batch <- api$batch(records, parallelCount = 5) 

# Start the batch task
batch$start()

# Get the task id to reference during or after its execution:
batch$id()

# If you need to cancel the batch execution, try this:
# batch$cancel()

# Monitor batch execution results using batch$results().
# Check results every 3 seconds until task finishes or fails. 
# Assign returned results to 'batchres'.
batchRes <- NULL
while(TRUE) {
   batchres <- batch$results()

   if (batchRes$status == batch$STATUS$failed) { stop("Batch execution failed") } 
   if (batchRes$status == batch$STATUS$complete) { break }
      
   Sys.sleep(3)
}
      
# Once the batch task is complete, get the execution records by index from 
# the results 'batchRes'. totalItemCount = # of records in data.

# For every record, return these four results: 
for(i in seq(batchRes$totalItemCount)) {

   #1. List of every file that was generated by this execution index.
       files <- batch$listFiles(i)
    
   #2. Display the file contents of each file returned in the above list.
       for (fileName in files) {
          content <- batch$fileContent(i, fileName)
          if (is.null(content)) { stop("Unable to get file") }
       }
 
   #3. Download files from execution index to the current working directory  
       # unless a dest = "<path>" is specified.

       # Download of a single named file: 
       batch$download(i, myHistogramFile)

       # Download of all files:
       batch$download(i, dest = "~bgates/dev/null")
   
   #4. Get execution results (e.g. service output) for a given index row returned as an array 
       exe <- batchRes$execution(i)
       singleRowDataFrame <- exc$outputParameters$output
}

# Print response output named `answer`
print(result$output("answer")) # 0.6418125  

# Since you're authenticated already, get `swagger.json` file now.
swagger <- api$swagger()
cat(swagger, file = "swagger.json", append = FALSE)
``` 

## Call web service and define record data

Once you have authenticated (see workflow example), you can retrieve the web service, assign it to a variable, and define the inputs to it as record data in a data frame (or CSV, TSV, ...). 

Generally speaking, the process for asynchronous batch consumption of a web service involves the following:
1. Call the web service on which the batch execution should be run
1. Define the record data for the batch execution task
1. Start the task
1. Monitor and interact with the task and its results
1. Get the execution results and download any files produced

========================

Other assumptions/questions:

1. O16N now supports two new inputs: rdata.frame and csv so we can use arrays, or lists.  
   - Batch specific only?? Or accepted input to any web service produced by O16N via mrsdeploy or API?  Is that true? 
   - What about for realtime scoring?

1. There are several new public function. They are:

**Batch functions performed on the service object**
Once you get the service object, you can use these public functions on that service.

| Function      | Description                                            |
| ------------- |--------------------------------------------------------|
| `batch` |	Define the data records, as a data.frame or flat list, to be batched, such as: `batch(records, parallelCount = 5)` |
| `start` |	Starts the execution of a batch scoring operation, such as `batch$start()` |
| `cancel` |	Cancel the current batch execution, such as `batch$cancel()`|
| `id` |	Get the execution identifier for the current batch process, such as `id <- batch$id()`         |
| `results` |	Download all files or just the helper function (default dest = getwd())  |
| `file` |	Get the results of the execution by filename  |
| `download` |	Download all files or just the helper function (default dest = getwd())  |

**Batch functions performed on the batch object**
Once you have the batch object, you can use these public functions to interact with it.

| Function      | Description                                            |
| ------------- |--------------------------------------------------------|
| `batch` |	Define the data records, as a data.frame or flat list, to be batched, such as: `batch(records, parallelCount = 5)` |
| `start` |	Starts the execution of a batch scoring operation, such as `batch$start()` |
| `cancel` |	Cancel the current batch execution, such as `batch$cancel()`|
| `id` |	Get the execution identifier for the current batch process, such as `id <- batch$id()`         |
| `results` |	Download all files or just the helper function (default dest = getwd())  |
| `file` |	Get the results of the execution by filename  |
| `download` |	Download all files or just the helper function (default dest = getwd())  |

1. We’ll need an example users can actually try out of the box on their own. Nothing that relies on data files or models the users don't have access to or instructions on how to create. 

1. Call the service by name/version
1. Define the data records, as a data.frame or flat list, to be batched
1. Start the batch execution
1. Get the batch results and any associated files
1. When necessary, cancel the batch execution



 A Batch Execution Service (BES) is a service that handles high volume, asynchronous, scoring of a batch of data records. 


Define a Batch



batch-task <- service$batch(records, parallelCount = 5)


parallelCount Number of threads used to process entries in the 
batch. Default value is 10. Please make sure not to use too 
high of a number because it might negatively impact performance.




## Register Batch by `data.frame` directly

```R
# Get service to batch
service <- getService("mtcars")

#
# Register batch by `data.frame` 
#
# mtcars is a data.frame of 11 cols with names (mpg, cyl, ..., carb)
# and 32 rows of numerics 
#
records <- mtcars

batch <- service$batch(records, parallelCount = 5)
```

## Register by data.frame/flat list via the base R function `read.csv()` 

```R
# Get service to batch
service <- getService("mtcars")

#
# Register batch by Comma-separated data (.csv)
#
# mtcars is a data.frame of 11 cols with names (mpg, cyl, ..., carb)
# and 32 rows of numerics 
#

records <- read.csv("mtcars.csv")
batch <- service$batch(records)

#
# Register batch by Tab-separated data (.tsv) 
#
# mtcars is a data.frame of 11 cols with names (mpg, cyl, ..., carb)
# and 32 rows of numerics 
#

records <- read.csv("mtcars.tsv", sep = "\t")
batch <- service$batch(records)

```

# New Batch Functions

Batching is accessible from the service object:

```R
# Get service to batch
service <- getService("mtcars")

# Register service to be batched
batch <- service$batch(inputs, parallelCount = 10)

# Find batch using its execution identifier
batch <- service$getBatch(id)

# Get the list of batch execution identifiers
ids <- service$getBatchExecutions()
```

### Get service to batch
```R
batch(inputs, parallelCount = 10)
```

**Arguments**

- inputs: `data.frame`, or a `list`
- parallelCount: default is `10`

**Return**

The `Batch` object

### Get batch by execution identifier

```R
getBatch(id)
```

**Arguments**

- id: The batch execution identifiers

**Return**

The `Batch` object


### List the Batch execution identifiers

```R
 getBatchExecutions()
```

**Return**

List of batch execution identifiers

## `Batch` object

Batching is accessible from the service object. 
Functions on the batch object.

```R
# Get service to batch
service <- getService("mtcars")

# Register service to be batched
batch <- service$batch(records, parallelCount = 10)

# Start batch execution
batch$start()

# Get execution identifier for the started batch process
id <- batch$id()

# Cancel batch execution
batch$cancel()

# Poll for batch execution results
batchResult <- batch$results(partialResults = TRUE)

# Get file content by filename
content <- batch$fileContent(index, fileName)
   
# Download helper function (default dest = getwd())
batch$download(index, fileName, dest = "~admin/dev/null") 

# Download all files
batch$download(index)
```

### Start batch execution

```R
start()
```

**Return**

The `Batch` object

### Cancel batch execution

```R
cancel()
```
**Return**

The `Batch` object

### Get execution identifier

```R
id()
```

**Return**

The execution identifier

### Get batch execution results

```R
batch$results(partialResult = TRUE)
```

**Arguments**

- partialResults: Returns the already processed results of the batch execution even if it has not been fully completed.

**Return**

The `BatchResult` object

### Get file content by filename

```R
file(index, fileName)
```

**Arguments**

- index: Batch execution record index
- filename: Name of file artifact created during batch execution

**Return**

### Download helper function (default dest = getwd())

```R
download(index, fileName, dest = getwd())
```

**Arguments**

- index: Batch execution record index
- filename: Name of file artifact created during batch execution
- dest: The download desition. The default is working directory.

**Return**

Filepath to download location

### Download all files

```R
download(index)
```
**Arguments**

- index: Batch execution record index

**Return**

List of filepaths to download location

## `BatchResult` object

### Get batch execution results

```R
execution(index)
```

**Arguments**

- index: Batch execution record index

**Return**

List of lists of batch execution results



## See also

+ [mrsdeploy function overview](../mrsdeploy/mrsdeploy.md)
+ [Data scientist get started guide](data-scientist-get-started.md)
+ [Working with web services in R](../operationalize/data-scientist-manage-services.md)
+ [Execute on a remote Microsoft R Server](../operationalize/remote-execution.md)
+ [Application developer get started guide](../operationalize/app-developer-get-started.md)
