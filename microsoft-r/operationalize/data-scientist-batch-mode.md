---

# required metadata
title: "Batch Scoring & Deployment"
description: "mrsdeploy Functions"
keywords: "mrsdeploy package reference"
author: "j-martens"
manager: "jhubbard"
ms.date: "2/14/2017"
ms.topic: "reference"
ms.prod: "microsoft-r"
ms.service: ""
ms.assetid: ""

# optional metadata
ROBOTS: ""
audience: ""
ms.devlang: ""
ms.reviewer: ""
ms.suite: ""
ms.tgt_pltfrm: ""
ms.technology: "r-server"
ms.custom: ""

---

# Asynchronous service consumption via batch processing

**Applies to:  Microsoft R Server 9.1**

The typical approach to consuming web services, ["Request Response" consumption](data-scientist-manage-services.md#consume-service), involves a single API call to execute the code in that web service once. In this article, you'll learn how to perform "Asynchronous Batch" consumption. The Asynchronous Batch approach involves the execution of code without manual intervention using multiple asynchronous API calls on a specific web service sent as a single request to R Server. Then, R Server will immediately execute those operations once for every row of data provided. 



## Asynchronous batch workflow

Generally speaking, the process for asynchronous batch consumption of a web service involves the following:
1. Call the web service on which the batch execution should be run
1. Define the data records for the batch execution task
1. Start (or cancel) the batch execution task
1. Monitor task and interact with results

Use these following [public API functions](data-scientist-manage-services.md#api-client-batch)  to define, start, and interact with your batch executions.

![Batch execution](../media/o16n/data-scientist-batch.png) 

**End-to-end workflow example**
For a quick review of the end-to-end workflow for asynchronous batch executions of web services, check out this example. Here we use the `mtService` web service that was published using the example in the [Get Started for Data Scientist](data-scientist-get-started.md) article. 

```R
##########################################################################
#            Perform Batch Consumption & Get Swagger in R                #
##########################################################################

# Use `remoteLogin` to authenticate with R Server using the local admin 
# account. Use session = false so no remote R session started
remoteLogin("http://localhost:12800", 
            username = “admin”, 
            password = “{{YOUR_PASSWORD}}”,
            session = FALSE)
   
# Get the service using `getService()` function from `mrsdeploy`
# Assign service to the variable `TxService`.
TxService <- getService("mtService", "v1.0.0")

# Define the record data for the batch execution task.  Record data comes 
# from a data.frame called mtcars. Note: mtcars is a data.frame of 
# 11 cols with names (mpg, cyl, ..., carb) and 32 rows of numerics. 
# Assign to the batch object called 'TxBatch'.
record <- mtcars
TxBatch <- TxService$batch(records) 

# Set thread count using parallelCount. Default is 10.
# TxBatch <- TxService$batch(records, parallelCount = 5) 

# Start the batch task
TxBatch$start()

# Get the task id to reference during or after its execution:
id <- TxBatch$id()

# If you need to cancel the batch execution, try this:
# TxBatch$cancel()

# Monitor batch execution results with public function $results().
# Check results every 3 seconds until task finishes or fails. 
# Assign returned results to batch result object we called 'batchres'.
batchRes <- NULL
while(TRUE) {
   batchRes <- TxBatch$results()

   if (batchRes$status == TxBatch$STATUS$failed) { stop("Batch execution failed") } 
   if (batchRes$status == TxBatch$STATUS$complete) { break }
      
   Sys.sleep(3)
}
      
# Once the batch task is complete, get the execution records by index from 
# the batch results object, 'batchRes'. This object is the service output.

# For every record, return these results (totalItemCount = # of data records)
for(i in seq(batchRes$totalItemCount)) {

   #1. List of every file that was generated by this execution index.
       files <- TxBatch$listFiles(i)
    
   #2. Display the file contents of each file returned in the above list.
       for (fileName in files) {
          content <- TxBatch$fileContent(i, fileName)
          if (is.null(content)) { stop("Unable to get file") }
       }
 
   #3. Download files from execution index to the current working directory  
       # unless a dest = "<path>" is specified.

       # Download of a single named file: 
       TxBatch$download(i, "HistogramFile.png")

       # Download of all files:
       TxBatch$download(i, dest = "~bgates/batchfiles/")
   
   #4. Get results for a given index row returned as an array 
       # assign it to 'exe' and output a data frame for each row. 
       exe <- batchRes$execution(i)
       singleRowDataFrame <- exe$outputParameters$output
}

# Print response output named `answer`
print(result$output("answer")) # 0.6418125  

# Since you're authenticated already, get `swagger.json` file now.
swagger <- TxService$swagger()
cat(swagger, file = "swagger.json", append = FALSE)
``` 

<a name="public-fx-batch"></a>

## Public functions used for asynchronous batch executions 

You can use the following supported public functions to consume a service asynchronously.

**Batch functions performed on the service object**

Once you get the service object, you can use these public functions on that service.

| Function      | Description                                            |
| ------------- |--------------------------------------------------------|
| `batch` |Define the data records  to be batched and the concurrent thread count. [Learn more...](data-scientist-get-started#batch-function)|
| `getBatchExecutions` |Get the list of batch execution identifiers |
| `getBatch` |Get batch object using its unique execution identifier |

**Batch functions performed on the batch object**

Once you have the batch object, you can use these public functions to interact with it.

| Function      | Description                                            |
| ------------- |--------------------------------------------------------|
| `start` |Starts the execution of a batch scoring operation, such as `batch$start()` |
| `cancel` |Cancel the named batch execution|
| `id` |Get the execution identifier for the named batch process         |
| `results` |Poll for batch execution results, partial or full results as defined|
| `STATUS` |Poll for the status of the batch execution (failed, complete, ...)|
| `listFiles` |List of every file that was generated by this execution index  |
| `fileContent` |Print the contents of the named file generated by the batch execution  |
| `download` |Download one or all files from execution index (default dest = getwd())  |
| `execution` |Get results for a given index row returned as an array  |


## 1: Get the web service

Once you have authenticated (see workflow example), you can retrieve the web service from R Server, assign it to a variable, and define the inputs to it as record data in a data frame (or CSV, TSV, ...). 

Batching begins by retrieving the web service containing the code against which you'll score the data records you define next. You can get a service using its name and version with the `getService()` function from `mrsdeploy`. The result is a service object, which in our example is called `TxService`.  The `getService` function is covered in detail in [this article](data-scientist-manage-services.md). 

For example:
```R   
TxService <- getService("mtService", "v1.0.0")
```

<a name="batch-function"></a>

## 2: Define the data records to be batched

Next, use the public api function `batch` to define the input record data for the batch and set the number of concurrent threads for processing. 

For example:
```R
TxBatch <- TxService$batch(inputs, parallelCount = 10)
```
The result is a batch object, which in our example is called `TxBatch`.

Arguments for public 'batch' function:
+ `inputs`: 
   + Specify the R data.frame name directly. For example:
     ```R
     # Use mtcars data.frame as input. Assign to batch object 'TxBatch'.
     # Reduce thread count to 5.

     TxBatch <- myService$batch(mtcars, parallelCount = 5)
     ```
  
   + Specify a flat list filename and convert it to a data.frame using the base R function, `read.csv`. For example:
     ```R
     # mtcars is a CSV file this time. Use read.csv to read in as data.frame.
     # Assign data.frame to 'records' variable. Then, use 'records' as input.
     records <- read.csv("mtcars.csv")
     TxBatch  <- myService$batch(records)
      
     # mtcars is a TSV file this time. Declare the separator.
     records <- read.csv("mtcars.tsv", sep = "\t")
     TxBatch  <- myService$batch(records)
     ``` 

- `parallelCount`: Default value is 10. Specify the number of concurrent threads that can be dedicated to processing records in the batch. Take care not to set a number so high that it negatively impacts performance.

<a name="start-function"></a>

## 3: Start or cancel the batch execution

Next, use the public api functions to start the asynchronous batch execution on the batch object, monitor the execution, or even cancel it.

### Start batch execution task
Start the batch task with the public function `start()`. R Server starts the batch execution and assigns an ID to the execution and returns the batch object. For example:
```R
TxBatch$start()
```

>[!NOTE]
> We suggest you always use the `id` function after you start the execution so that you can find it easily with this id later such as: `TxBatch$start()$id()`

### Get batch id
Get the batch task's identifier to reference during or after its execution with the public function `id()`. R Server returns the ID for the named batch object. For example:
```R
TxBatch$id()
```

### Cancel execution
Cancel the named batch execution using the public function `cancel()`. R Server returns the batch object. 

```R
TxBatch$cancel()
```


## 4: Monitor and interact with results

While the batch task is running, you can monitor and poll the results. Once the batch task has completed, you can get the web service consumption output by index from the batch results object, including:
+ Get a list of every file that was generated by this execution index
+ See the file contents of a specific file or every file returned
+ Download files from execution index  
+ Get results for a given index row returned as an array 


### Monitor execution results and status
You can monitor the batch execution results with the public function `results()` and the status of the batch execution using the public function `STATUS`. 

```R
TxBatch$results()
```

For example, the following polls the results and returns partial results every three seconds until the batch execution fails or completes:
```R
batchRes <- NULL
while(TRUE) {
   batchRes <- TxBatch$results()

   if (batchRes$status == TxBatch$STATUS$failed) { stop("Batch execution failed") } 
   if (batchRes$status == TxBatch$STATUS$complete) { break }
      
   Sys.sleep(3)
}
```

For example, the following checks to see if the batch execution is completed every three seconds. It will only return the results if the execution has completed (`partialResults = FALSE`):
```R
batchRes <- NULL
while(TRUE) {
   batchRes <- TxBatch$results(partialResults = FALSE)

   if (batchRes$status == TxBatch$STATUS$failed) { stop("Batch execution failed") } 
   if (batchRes$status == TxBatch$STATUS$complete) { break }
      
   Sys.sleep(3)
}
```

### Get list of generated files

Retrieve a list of every file that was generated during the batch execution for a given data record, or index,with the public function `listFiles()`. This can be made part of a loop to get the list of the files for every data record (see workflow example for a loop). For example:

```R
TxBatch$listFiles()
```

### Display file contents

Display the file contents of a named file returned in the above list with the public function `fileContent()`. R Server returns the ID for the named batch object. 

```R
TxBatch$fileContent(index, fileName)
```

Arguments for public 'fileContent' function:
+ `index`: Batch execution record index
+ `fileName`: Name of file artifact created during batch execution
 

### Download generated files 

Download the file(s) from a specific execution index with the public function `download()`. By default, files are downloaded to the current working directory `getwd()` unless a different `dest = "<path>"` is specified.

You can choose to download a specific file or all files. The path to each downloaded file is returned. 

```R
TxBatch$download(index, "fileName", dest = "<path>")
```

Arguments for public 'batch' function:
+ `index`: Index value for a given batch data record
+ `fileName`: Name of specific file generated during batch execution. If omitted, all files are downloaded for that index.
+ `dest`: The download directory on your local machine. The default is the current R working directory.

For example, you can download a named file for the `1000`th index to a specified directory  as follows:

```R
#Download a named file for 5th index to the specified directory
TxBatch$download(5, "HistogramFile.png", dest = "~bgates/batchfiles/")

# Download all files for a given index to the default current R working directory in a loop
for(i in seq(batchRes$totalItemCount)) {
  TxBatch$download(i)
}
``` 

### Get results for a record as an array
Cancel the named batch execution using the public function `cancel()`. R Server returns the batch object. For example:
```R
TxBatch$cancel()
```


```R
   #4. Get results for a given index row returned as an array 
       # assign it to 'exe' and output a data frame for each row. 
       exe <- batchRes$execution(i)
       singleRowDataFrame <- exe$outputParameters$output
``` 























### Get batch execution results

```R
batch$results(partialResult = TRUE)
```

**Arguments**

- partialResults: Returns the already processed results of the batch execution even if it has not been fully completed.

**Return**

The `BatchResult` object




## `BatchResult` object

### Get batch execution results

```R
execution(index)
```

**Arguments**

- index: Batch execution record index

**Return**

List of lists of batch execution results



## See also

+ [mrsdeploy function overview](../mrsdeploy/mrsdeploy.md)
+ [Connecting to R Server with mrsdeploy](mrsdeploy-connection.md)
+ [Data scientist get started guide](data-scientist-get-started.md)
+ [Working with web services in R](../operationalize/data-scientist-manage-services.md)
+ [Execute on a remote Microsoft R Server](../operationalize/remote-execution.md)
+ [Application developer get started guide](../operationalize/app-developer-get-started.md)